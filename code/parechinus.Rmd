---
title: "parechinus"
author: "Aimee"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(knitr)  
setwd("C:/Users/aimee/OneDrive - University of Cape Town/OneDrive - University of Cape Town/msc_thesis/parechinus/data")
#library(reticulate)  
#knitr::knit_engines$set(python = reticulate::eng_python)  
#library(reticulate)
#use_python("C:/Users/aimee/AppData/Local/Programs/Python/Python39/python.exe")
#py_config()
```

This project aims to compare 8 treatments in terms of:

1.  Somatic growth rate (g/month and cm/month)

2.  Feed conversion ratio

3.  Gonad quality

4.  Gonad development

### 1.  **Somatic Growth Rate**

```{r load data, echo = FALSE}
setwd("C:/Users/aimee/OneDrive - University of Cape Town/OneDrive - University of Cape Town/msc_thesis/parechinus/data")
parechinus_data <- read_excel("C:/Users/aimee/OneDrive - University of Cape Town/OneDrive - University of Cape Town/msc_thesis/parechinus/data/parechinus_data.xlsx")

measurement_data <- read_excel("C:/Users/aimee/OneDrive - University of Cape Town/OneDrive - University of Cape Town/msc_thesis/parechinus/data/measurement_data.xlsx")

#FCR_weight <- read_excel("FCR_data.xlsx", sheet = "weight")
#FCR_feed <- read_excel("FCR_data.xlsx", sheet = "feed")
```

```{r create diet and temp factors, include=FALSE}

factorise_treatments <- function(data){
data$tank = as.factor(data$tank)
unclass(data$tank)

data$diet = as.factor(data$diet)
unclass(data$diet)

data$temperature = as.factor(data$temperature)
unclass(data$temperature)

# data$treatment = as.factor(data$treatment)
# unclass(data$treatment)
}

factorise_treatments(parechinus_data)
factorise_treatments(measurement_data)

```



# In terms of weight
```{r subset data by treatment, echo = FALSE}

data<- parechinus_data

fa <- data %>% 
  filter(temperature == "ambient", diet == "formulated")

fw <- data %>% 
  filter(temperature == "warm", diet == "formulated") 

ma <- data %>% 
  filter(temperature == "ambient", diet == "mixed")

mw <- data %>% 
  filter(temperature == "warm", diet == "mixed")

ua <- data %>% 
  filter(temperature == "ambient", diet == "ulva")

uw <- data %>% 
  filter(temperature == "warm", diet == "ulva")

ka <- data %>% 
  filter(temperature == "ambient", diet == "kelp")

kw <- data %>% 
  filter(temperature == "warm", diet == "kelp")


```



## Descriptive statistics:


function for weight:
```{r message=FALSE, warning=FALSE, include=FALSE}
urchin_data <- data

descriptive_table_notkelp <- function(data){
attach(data)
#########################################
# Creating a rounded descriptive table
#########################################
#** Creating the stats this you need to change
# Categorical variable
X = time
# Numerical variable
Y = `weight (g)`
dat = data
########################################

#*****************************************
#****This does not change
Mean = aggregate(Y~X,data=dat,FUN=mean)
Stdev = aggregate(Y~X,data=dat,FUN=sd)
Var = aggregate(Y~X,data=dat,FUN=var)
n = aggregate(Y~X,data=dat,FUN=length)

# Create a table with the aggregated data
Dstats = data.frame(Mean, Stdev, Var, n)
Dstats
#******************************************

###########################################
# Part you need to change!
# Number of decimal places to round to 
###########################################
# decimals for mean and standard deviation are the same 
Deci1 = 2   
# Variance number of decimals twice that of the mean
Deci2 = 4
# Naming the Categorical variable
CatN = "Month"
# R assigns it's categories alphabetically
summary(data)
unclass(data$time)
data$time = as.factor(data$time)
unclass(data$time)

#attr(,"levels")
#[1] "0" "1" "4" "8"
# Copy the order of the variables EXACTLY
Catagorical = c("0","1", "2", "3", "4")
#############################################

#********************************************
# ***This does not change
# Creating rounded variables
# Round Mean & St.dev (g) to the same decimal places 
DstatsR1 = round(Dstats[,c(2,4)], Deci1)
# Round the variance  (g^2) to the correct number of decimal places
DstatsR2 = round(Dstats[,6], Deci2)
# Sample size
DstatsR3 = round(Dstats[,8],0)

# Creating a table with the categories 
#    and the descriptive stats
Descriptive4 = data.frame(Catagorical, 
                          DstatsR1, DstatsR2, DstatsR3) 
#**********************************************

################################################
# *** Setting up table column headers
# This needs to change every time 
# labels:

MeanL = "Mean (g)"
SdL = "St. dev (g)"
VarL = "Var (g^2)"
nL = "n"
################################################

#**************************************************
# This part does not need to change

names(Descriptive4) = c(CatN, MeanL, SdL, VarL, nL)
# Now order the table by ascending Mean for 
# interpretation
# Order() -- Tells R you want to sort the data
# Descriptive$Mean -- Tells what variable in the table you 
# want to sort it by
# decreasing = False -- Sort in ascending order
Descriptive = Descriptive4[order(Descriptive4$Mean,
                                 decreasing=FALSE),]
Descriptive
}


descriptive_table_kelp <- function(data){
attach(data)
#########################################
# Creating a rounded descriptive table
#########################################
#** Creating the stats this you need to change
# Categorical variable
X = time
# Numerical variable
Y = `weight (g)`
dat = data
########################################

#*****************************************
#****This does not change
Mean = aggregate(Y~X,data=dat,FUN=mean)
Stdev = aggregate(Y~X,data=dat,FUN=sd)
Var = aggregate(Y~X,data=dat,FUN=var)
n = aggregate(Y~X,data=dat,FUN=length)

# Create a table with the aggregated data
Dstats = data.frame(Mean, Stdev, Var, n)
Dstats
#******************************************

###########################################
# Part you need to change!
# Number of decimal places to round to 
###########################################
# decimals for mean and standard deviation are the same 
Deci1 = 2   
# Variance number of decimals twice that of the mean
Deci2 = 4
# Naming the Categorical variable
CatN = "Month"
# R assigns it's categories alphabetically
summary(data)
unclass(data$time)
data$time = as.factor(data$time)
unclass(data$time)

#attr(,"levels")
#[1] "0" "1" "4" "8"
# Copy the order of the variables EXACTLY
Catagorical = c("0","1", "2")
#############################################

#********************************************
# ***This does not change
# Creating rounded variables
# Round Mean & St.dev (g) to the same decimal places 
DstatsR1 = round(Dstats[,c(2,4)], Deci1)
# Round the variance  (g^2) to the correct number of decimal places
DstatsR2 = round(Dstats[,6], Deci2)
# Sample size
DstatsR3 = round(Dstats[,8],0)

# Creating a table with the categories 
#    and the descriptive stats
Descriptive4 = data.frame(Catagorical, 
                          DstatsR1, DstatsR2, DstatsR3) 
#**********************************************

################################################
# *** Setting up table column headers
# This needs to change every time 
# labels:

MeanL = "Mean (g)"
SdL = "St. dev (g)"
VarL = "Var (g^2)"
nL = "n"
################################################

#**************************************************
# This part does not need to change

names(Descriptive4) = c(CatN, MeanL, SdL, VarL, nL)
# Now order the table by ascending Mean for 
# interpretation
# Order() -- Tells R you want to sort the data
# Descriptive$Mean -- Tells what variable in the table you 
# want to sort it by
# decreasing = False -- Sort in ascending order
Descriptive = Descriptive4[order(Descriptive4$Mean,
                                 decreasing=FALSE),]
Descriptive
}


# fa_weight<- Mean
# names(fa_weight) <- c("Month", "Mean weight (g)")
# 
# fa_weight_mean <- Mean
# names(fa_weight_mean) <- c("Month", "Mean weight (g)")
# fa_weight_sd <- Stdev
# names(fa_weight_sd) <- c("Month", "sd(g)")

```

using function for weight:
```{r echo=FALSE, message=FALSE, warning=FALSE}
fa_descriptive <- descriptive_table_notkelp(fa)
fw_descriptive <- descriptive_table_notkelp(fw)
ma_descriptive <- descriptive_table_notkelp(ma)
mw_descriptive <- descriptive_table_notkelp(mw)
ua_descriptive <- descriptive_table_notkelp(ua)
uw_descriptive <- descriptive_table_notkelp(uw)

kw_descriptive <- descriptive_table_kelp(kw)
ka_descriptive <- descriptive_table_kelp(ka)



```

plot actual weights
```{r summarise actual data}
summarise_weight <- function(data){
initial_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 0) %>% 
  summarise(weight = round(mean(`weight (g)`), digits = 2),sd = round(sd(`weight (g)`), digits = 2),se = round((sd(`weight (g)`)/sqrt(length(`weight (g)`))), digits = 2), var = round(var(`weight (g)`), digits = 4),n = length(`weight (g)`),week = 0)

month1_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 1) %>% 
  summarise(weight = round(mean(`weight (g)`), digits = 2),sd = round(sd(`weight (g)`), digits = 2),se = round((sd(`weight (g)`)/sqrt(length(`weight (g)`))), digits = 2), var = round(var(`weight (g)`), digits = 4),n = length(`weight (g)`),week = 4)

month2_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 2) %>% 
  summarise(weight = round(mean(`weight (g)`), digits = 2),sd = round(sd(`weight (g)`), digits = 2),se = round((sd(`weight (g)`)/sqrt(length(`weight (g)`))), digits = 2), var = round(var(`weight (g)`), digits = 4),n = length(`weight (g)`),week = 8)

month3_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 3) %>% 
  summarise(weight = round(mean(`weight (g)`), digits = 2),sd = round(sd(`weight (g)`), digits = 2),se = round((sd(`weight (g)`)/sqrt(length(`weight (g)`))), digits = 2), var = round(var(`weight (g)`), digits = 4),n = length(`weight (g)`),week = 13)

month4_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 4) %>% 
  summarise(weight = round(mean(`weight (g)`), digits = 2),sd = round(sd(`weight (g)`), digits = 2),se = round((sd(`weight (g)`)/sqrt(length(`weight (g)`))), digits = 2),var = round(var(`weight (g)`), digits = 4),n = length(`weight (g)`),week = 18)

all_weight <- bind_rows(initial_dat, month1_dat, month2_dat, month3_dat, month4_dat)

}

all_weight <- summarise_weight(parechinus_data)






```


```{r plot actual data}

attach(all_weight)
ggplot(all_weight, aes(x = week, y = weight, color = as.factor(treatment))) +
  geom_line() +
  geom_point() +  geom_errorbar(aes(ymin = weight - se, ymax = weight + se), width = 0.2) +
  labs(title = "Cape sea urchin weight (g) over time",
       x = "Week",
       y = "Total body weight (g)",
       color = "Treatment") +
  theme_classic() + theme(plot.title = element_text(family = "TT Times New Roman", hjust = 0.5))


# plot(week, weight, col = as.factor(treatment), xlab = "Week", ylab = "Weight (g)", ylim = range(c(weight-sd, weight+sd)))
# arrows(week,(weight-sd),week,(weight+sd),length = 0.5,angle = 90, code = 3, col = as.factor(treatment))


```


##Growth calculation

###SGR 
function for SGR weight calculation:
```{r data_transform_weight_growth_SGR}
data<- parechinus_data

data_transform_weight_growth_SGR <- function(data){
initial_dat <- data %>% 
  group_by(tank,diet, temperature, treatment) %>% 
  filter(time == 0) %>% 
  summarise(T0_weight = round(mean(`weight (g)`), digits = 2),T0_weight_sd = round(sd(`weight (g)`), digits = 2),T0_weight_var = round(var(`weight (g)`), digits = 4),T0_weight_n = length(`weight (g)`), week = 0)


month1_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 1) %>% 
  summarise(T1_weight = round(mean(`weight (g)`), digits = 2),T1_weight_sd = round(sd(`weight (g)`), digits = 2),T1_weight_var = round(var(`weight (g)`), digits = 4),T1_weight_n = length(`weight (g)`))

month2_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 2) %>% 
  summarise(T2_weight = round(mean(`weight (g)`), digits = 2),T2_weight_sd = round(sd(`weight (g)`), digits = 2),T2_weight_var = round(var(`weight (g)`), digits = 4),T2_weight_n = length(`weight (g)`))

month3_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 3) %>% 
  summarise(T3_weight = round(mean(`weight (g)`), digits = 2),T3_weight_sd = round(sd(`weight (g)`), digits = 2),T3_weight_var = round(var(`weight (g)`), digits = 4),T3_weight_n = length(`weight (g)`))

#set kelp tanks weight to zero
# Find tanks that are only in month4_dat
kelp_tanks <- setdiff(month2_dat$tank, month3_dat$tank)

# Create a data frame with these tanks and set w_growth to 0
additional_data_month3 <- data.frame(tank = kelp_tanks,diet = "kelp", T3_weight = 0)

month3_dat <- bind_rows(month3_dat, additional_data_month3)

month4_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 4) %>% 
  summarise(T4_weight = round(mean(`weight (g)`), digits = 2),T4_weight_sd = round(sd(`weight (g)`), digits = 2),T4_weight_var = round(var(`weight (g)`), digits = 4),T4_weight_n = length(`weight (g)`))

#set kelp tanks weight to zero

# Create a data frame with these tanks and set w_growth to 0
additional_data_month4 <- data.frame(tank = kelp_tanks,diet = "kelp", T4_weight = 0)
month4_dat <- bind_rows(month4_dat, additional_data_month4)

  
growth_dat1 <- left_join(initial_dat, month1_dat, by = "tank") %>% 
  group_by(tank) %>% 
  mutate(w_growth1 = 100*(log(T1_weight/T0_weight))/29) %>% distinct()

growth_dat2 <- left_join(month1_dat, month2_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(w_growth2 = 100*(log(T2_weight/T1_weight))/29) %>% distinct()


growth_dat3 <- left_join(month2_dat,month3_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(w_growth3 = coalesce((100*(log(T3_weight/T2_weight))/32),0)) %>%  distinct()




#growth_dat3 <- replace(growth_dat3, is.na(growth_dat3),0)


growth_dat4 <- left_join(month3_dat,month4_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(w_growth4 = coalesce((100*(log(T4_weight/T3_weight))/36), 0)) %>% distinct() %>%mutate(tank = as.numeric(tank)) %>%
  arrange(tank)



growth_dat <- data.frame(growth_dat1[,1:4],growth_dat1$w_growth1,growth_dat2$w_growth2, growth_dat3$w_growth3, growth_dat4$w_growth4)

names(growth_dat) <- c("tank", "diet", "temperature", "treatment", "w_growth1", "w_growth2", "w_growth3", "w_growth4")


# Setting growth rate 3 to zero for kelp tanks
tanks_to_set_to_zero <- kelp_tanks

# Use mutate() and ifelse() to change the values
growth_dat <- growth_dat %>%
  mutate(w_growth3 = ifelse(tank %in% tanks_to_set_to_zero, 0, w_growth3), w_growth4 = ifelse(tank %in% tanks_to_set_to_zero, 0, w_growth4))

growth_dat <- round(growth_dat[,5:8],digits = 2)

growth_dat <- data.frame(month1_dat[,1:4],growth_dat)
names(growth_dat) <- c("tank", "diet", "temperature", "treatment", "w_growth1", "w_growth2", "w_growth3", "w_growth4")
growth_dat
}

weight_SGR_dat <- data_transform_weight_growth_SGR(data)


```


## look for significant differences:

check normality and homoscedasticity
```{r}
#*********************************
#** Shapiro-Wilk normality test **
#*********************************
# If p > 0.05, we can be 95% certain that the 
# data are normally distributed. 
# (In other words, the null hypothesis is 
#   probably true.) 
# If p < 0.05, we can be 95% certain that the 
# data are not normally distributed. 
# (In other words, the null hypothesis is 
#   probably false.) 

# H0: The data are normally distributed
# H1: The data are not normally distributed
# alpha = 0.05

shapiro.test(weight_SGR_dat$w_growth1) #W = 0.97628, p-value = 0.6867
shapiro.test(weight_SGR_dat$w_growth2) #W = 0.9383, p-value = 0.06699
shapiro.test(weight_SGR_dat$w_growth3) #not normal #W = 0.91693, p-value = 0.01718
shapiro.test(weight_SGR_dat$w_growth4) #W = 0.96391, p-value = 0.3499

#*********************************
#** Levene homoscedasticity test **
#*********************************
#If values are significant, the treatment group data does not have equal variances

require("car")

leveneTest(weight_SGR_dat$w_growth1~weight_SGR_dat$treatment) #equal variance
#       Df F value Pr(>F)
# group  7   1.127 0.3792
#       24     
leveneTest(weight_SGR_dat$w_growth2~weight_SGR_dat$treatment) #not equal variance
#       Df F value  Pr(>F)  
# group  7  2.8723 0.02506 *
#       24    
leveneTest(weight_SGR_dat$w_growth3~weight_SGR_dat$treatment) #not equal variance
#       Df F value   Pr(>F)   
# group  7  4.2341 0.003595 **
#       24
leveneTest(weight_SGR_dat$w_growth4~weight_SGR_dat$treatment) #equal variance
#       Df F value Pr(>F)
# group  7  1.7097 0.1542
#       24           
```


create descriptive tables
```{r desciptive tables for ANOVA, echo = FALSE }
#We want to see if weight gain (g) differs between treatments

attach(weight_SGR_dat)
# names(weight_SGR_dat)
# summary(weight_SGR_dat)
# 
# unclass(treatment)
# weight_SGR_dat$treatment = as.factor(weight_SGR_dat$treatment)
# unclass(weight_SGR_dat$treatment)
# summary(weight_SGR_dat)

dat <- weight_SGR_dat
#growth_period is e.g. w_growth 1
treatment_weight_growth_table <- function(growth_period){


#########################################
# Creating a rounded descriptive table
#########################################
#** Creating the stats this you need to change
# Categorical variable
X = treatment
# Numerical variable
Y = growth_period
data = weight_SGR_dat
########################################

#*****************************************
#****This does not change
Mean = aggregate(Y~X,data=dat,FUN=mean)
Stdev <- aggregate(Y~X, data = dat, FUN = sd)
#Stdev = aggregate(Y~X,data=dat,FUN=sd)
Var = aggregate(Y~X,data=dat,FUN= var)
n = aggregate(Y~X,data=dat,FUN=length)

# Create a table with the aggregated data
Dstats = data.frame(Mean, Stdev, Var, n)
Dstats
#******************************************

###########################################
# Part you need to change!
# Number of decimal places to round to 
###########################################
# decimals for mean and standard deviation are the same 
Deci1 = 3   
# Variance number of decimals twice that of the mean
Deci2 = 6
# Naming the Categorical variable
CatN = "Treatments"
# R assigns it's categories alphabetically
summary(dat)
unclass(dat$treatment)
#attr(,"levels")
#[1] "A" "B" "C" "D" "E"
# Copy the order of the variables EXACTLY
Catagorical = c("FA","FW","KA","KW","MA", "MW", "UA", "UW")
#############################################

#********************************************
# ***This does not change
# Creating rounded variables
# Round Mean & St.dev (g) to the same decimal places 
DstatsR1 = round(Dstats[,c(2,4)], Deci1)
# Round the variance  (g^2) to the correct number of decimal places
DstatsR2 = round(Dstats[,6], Deci2)
# Sample size
DstatsR3 = round(Dstats[,8],0)

# Creating a table with the categories 
#    and the descriptive stats
Descriptive4 = data.frame(Catagorical, 
                          DstatsR1, DstatsR2, DstatsR3) 
#**********************************************

################################################
# *** Setting up table column headers
# This needs to change every time 
# labels:
MeanL = "Mean (g)"
SdL = "St. dev (g)"
VarL = "Var (g^2)"
nL = "n"
################################################

#**************************************************
# This part does not need to change
names(Descriptive4) = c(CatN, MeanL, SdL, VarL, nL)
# Now order the table by ascending Mean for 
# interpretation
# Order() --> Tells R you want to sort the data
# Descriptive$Mean --> Tells what variable in the table you 
# want to sort it by
# decreasing = False --> Sort in ascending order
Descriptive = Descriptive4[order(Descriptive4$Mean,
                                 decreasing=FALSE),]
Descriptive


}

dat_SGR1<- treatment_weight_growth_table(w_growth1)
dat_w_growth2<- treatment_weight_growth_table(w_growth2)
dat_w_growth3<- treatment_weight_growth_table(w_growth3)
dat_w_growth4<- treatment_weight_growth_table(w_growth4)

#write.table(dat_w_growth3,"clipboard", sep = "\t")

#******************************************************

# Table 1.  Descriptive statistics for body weights (g) for each
#           of the five different Islands where the mean, standard
#           deviation (St.dev), Variance (Var) and sample size (n).
        # Island  Mean(g)  St. dev(g)    Var(g^2)    n
        #5      E 38.47    6.74           45.4033    40
        #1      A 42.38    7.27           52.8032    40
        #2      B 53.98    7.17           51.4261    40
        #4      D 54.30    7.27           52.8269    40
        #3      C 54.74    7.24           52.4738    40



#** Question: Is there a difference in Weight 
#    between the treatments


```



boxplots 

```{r}
# data exploration using a box plot

#growth_period is e.g. w_growth 1

treatment_weight_growth_boxplot <- function(growth_period){
#** Visualizing what the data look like
ylab="Weight difference (g)"
xlab="Treatments"
par(las = 1)
boxplot(growth_period~treatment, data=dat, 
        ylab=ylab, 
        xlab=xlab, col= c("red", "red", "yellow", "yellow", "blue", "blue", "green", "green"))
legend("bottomright", c("IQR","Median","Outlier"), 
       pch=c(22,15,1), bty="n")
}


treatment_weight_growth_boxplot(w_growth1)
treatment_weight_growth_boxplot(w_growth2)
treatment_weight_growth_boxplot(w_growth3)
treatment_weight_growth_boxplot(w_growth4)

#** You have more than two levels and continuous data
#** So do ANOVA or Kruskal Wallis 
#   Either test assumptions beforehand or fit ANOVA
#   and test assumptions after.

#><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>
```




## ANOVA or Kruskal Wallis:

First check normality and homoscedasticity
```{r normality & homoscedasticity}


shapiro.test(all)


require("car")
leveneTest(Ratio~Tank, data = wk0)
leveneTest(logRatio~Tank, data = wk0)

```



Run ANOVA, then check assumptions, if not met, do Kruskal Wallis
```{r check ANOVA assumptions}

#*** run an ANOVA using the aov function
#*** First fit the model to check the assumptions
#**Then see if there is a difference between or among groups


# H0: muE = muA = muB = muD = muC 
      #(The mean weights are the same on each island)
# H1: the mean weights are not the same on each island
# alpha = 0.05
#Anova = aov(numerical~Categorical, data = dat)


anova_and_modelval <- function(growth_period){
anova1 <- aov(growth_period~diet*temperature,data=dat)
#model validation graphs
res <- residuals(anova1)
## Now pull out your fitted values
yfit <- fitted.values(anova1)

xlab1="Predicted values (g)"
ylab1="Residuals (g)"
par(mfrow=c(1,3),mex=0.8, las = 1, mai = c(0.5,0.5,0.5,0.1))
## Looking at the spread of the residuals to check Variances. 
##   Remember to add units to both labels 
plot(yfit,res,xlab=xlab1,ylab=ylab1)
abline(0,0,lty=3)
legend ("topleft", expression(bold("a")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
### Looking at Normality.  Remember to add units to the 
###   residual label
qqnorm(res,main="Model Validation")
qqline(res)
legend ("topleft", expression(bold("b")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
hist(res,main= "",xlab=ylab1)
legend ("topleft", expression(bold("c")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
}

#look at model validation before continuing
# Look at the model validation Figures to check the 
# assumptions
#Figure a checks the assumption of equal variance, 
#   if the spread of the residuals is similar 
#   above and below the line and there is no 
#   pattern in the residuals the variances are 
#   similar.
#Figure b-c checks the assumption of a normal 
#  distribution, if the points for the residuals 
#  in Figure b follow close to the line the data 
#  are normal.  If the histogram in Figure c has the 
#  bell shaped curve the data are normally distributed

#So if the assumptions are met, use the ANOVA results; 
  #if the data are not normal do a Kruskal Wallis
anova_and_modelval(w_growth1) #looks okay
anova_and_modelval(w_growth2) #spread of residuals has pattern,can I remove kelp?
anova_and_modelval(w_growth3) #residuals not normally distributed, try without kelp?
anova_and_modelval(w_growth4) #doesn't look too bad, odd pattern in b where it doesn't follow the line but otherwise looks normal, still think should try without kelp

anova1 <- aov(w_growth1~diet+temperature,data=weight_SGR_dat)
summary(anova1)

```

Removing kelp for growth period 2 to 4
This function isn't really working, I did it manually for the growth periods 2-4
```{r ANOVA without kelp}

weight_growth_dat_no_kelp <- weight_growth_dat %>% filter(diet!= "kelp")
dat <- weight_growth_dat_no_kelp

no_kelp_anova_and_modelval <- function(growth_period){
anova1 <- aov(w_growth4~temperature,data=weight_growth_dat_no_kelp)
#model validation graphs
res <- residuals(anova1)
## Now pull out your fitted values
yfit <- fitted.values(anova1)

xlab1="Predicted values (g)"
ylab1="Residuals (g)"
par(mfrow=c(1,3),mex=0.8, las = 1, mai = c(0.5,0.5,0.5,0.1))
## Looking at the spread of the residuals to check Variances. 
##   Remember to add units to both labels 
plot(yfit,res,xlab=xlab1,ylab=ylab1)
abline(0,0,lty=3)
legend ("topleft", expression(bold("a")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
### Looking at Normality.  Remember to add units to the 
###   residual label
qqnorm(res,main="Model Validation")
qqline(res)
legend ("topleft", expression(bold("b")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
hist(res,main= "",xlab=ylab1)
legend ("topleft", expression(bold("c")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
}

summary(anova1)

no_kelp_anova_and_modelval(w_growth2)
anova_and_modelval(w_growth3) 
anova_and_modelval(w_growth4)
```


```{r check ANOVA results }
anova_results <- function(growth_period){
anova1 <- aov(growth_period~treatment,data=dat)
summary(anova1)
}

#growth period 1
aov_wgrowth1<- anova_results(w_growth1)

```

Post Hoc Tukey test

```{r}
#dat <- weight_growth_dat
anova1 <- aov(w_growth4~diet,data=weight_SGR_dat)
summary(anova1)
#><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>
###### Tukey post-hoc test for anova #######
#><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>
# H0: mu1 = mu2 for all pairwise comparisons (Table3)
#     (the means in each pair are equal)
# H1: mu1 =/ mu2 for all pairwise comparisons (Table3)
#     (the means in each pair are not equal) 

## The test ##
# ordered = TRUE --> compares means in an ordered way 
#    just like they have been sorted
Tukey1 = TukeyHSD(anova1, ordered=TRUE) 
Tukey1

# Creating the rounded table - this does not change
Tukey.result = data.frame(unclass(Tukey1))

################################################
# Part you need to change!
# Number of decimal places to round to 
#################################################
# decimals for difference in means and Lwr 
# & upr confidence interval (CI) 
Deci3 = 3   
# decimals for the p-value
Deci4 = 3
# Getting comparisons
Comp = row.names(Tukey.result)
Comp
#Pairwise hypotheses
H0 = c("muU = muK", "muM = muK", "muF = muK", "muM = muU",
       "muF = muU", "muF = muM")
H1 = c("muU =/ muK", "muM =/ muK", "muF =/ muK", "muM =/ muU",
       "muF =/ muU", "muF =/ muM")
################################################

#************************************************
# *** This does not need to change
# Round difference mean decimals
TukeyM = round(Tukey.result[,1], Deci3)
# Round p-value to set number of decimals
Tukeyp = round(Tukey.result[,4], Deci4)
# Conclusion whether you accept or reject Ho
TukeyC = Tukey.result[,4]
TukeyC = ifelse(TukeyC < 0.05, "Reject H0", "Accept H0")
# Replacing the 0.000 values with < 0.001
Tukeyp[Tukeyp < 0.001] = "< 0.001"
#************************************************

#################################################
# Creating the labels for the columns
# This changes every time
# Remember units
################################################
diffML = "diff in Mean (%growth/day)" 
pL = "p.value"
###############################################

#***********************************************
# This does not change
# Rounded Tukey table
TukeyR = data.frame(Comp,H0,H1,TukeyM,Tukeyp,TukeyC)
names(TukeyR) = c("Comparison","H0", "H1", diffML, pL, "Conclusion")
TukeyR
#************************************************

###############################################
## Sorting the data -> this needs to change every time
# Create an arbitrary variable to help you sort correctly
dat_w_growth1[,1]
# E A B D C  --> Assign according to order
TukeyR[,1]
#[1] A-E B-E D-E C-E B-A D-A C-A D-B C-B C-D
# Assign a number to each grouping
Sorting = c(1,1,1,2,2,3)
# So all comparisons with E get 1, with A get 2 etc
#################################################

#**********************************************
# Creating a sorted table, this does not change
TukeyR2 = data.frame(Sorting,TukeyR)
#Sorting the data first by group and then by difference in Mean
TukeyR2 = TukeyR2[order(TukeyR2$Sorting, -TukeyR2[,5]),]
TukeyR2
names(TukeyR2) = c("Sort","Comparison","H0", "H1", 
                   diffML, pL, "Conclusion")
#Call the table without the sorting variable
TukeyR2[,2:7]

# Table 3. Results of a Tukey multiple pairwise comparison test comparing 
#       mean body weights (g) of mice among each of the five islands A to E.  
#       The islands in each pairwise comparison are shown (comparison) along 
#       with the pairwise null hypothesis (H0), the pairwise alternate 
#       hypothesis (H1), the difference in the means of the two islands 
#       (diff in Mean (g)), the probability (p.value) from the Tukey test 
#       and the conclusion.

  #Comparison        H0         H1      diff in Mean (g) p.value Conclusion
  #   C-E       muC = muE   muC =/ muE            16.28 < 0.001  Reject H0
  #   D-E       muD = muE   muD =/ muE            15.83 < 0.001  Reject H0
  #   B-E       muB = muE   muB =/ muE            15.51 < 0.001  Reject H0
  #   A-E       muA = muE   muA =/ muE             3.91   0.107  Accept H0
  #   C-A       muC = muA   muC =/ muA            12.36 < 0.001  Reject H0
  #   D-A       muD = muA   muD =/ muA            11.92 < 0.001  Reject H0
  #   B-A       muB = muA   muB =/ muA            11.60 < 0.001  Reject H0
  #   C-B       muC = muB   muC =/ muB             0.76   0.989  Accept H0
  #   D-B       muD = muB   muD =/ muB             0.32   1.000  Accept H0
  #   C-D       muC = muD   muC =/ muD             0.45   0.999  Accept H0

#Look at the p-values to see which island means differ from each other
# ** So from this we can see that mice from Islands A and E have 
#    similar body weights (Table 4.4, p=0.107) and mice from islands 
#    B, D and C have similar body weights (Table 4.4, p > 0.05), but 
#    that mice from these two groups of islands (AE and BDC) have 
#    different mean body weights (Table 4.4, p <0.05).

# Means ordered: muE muA muB muD muC
# Thus the H1 for the ANOVA model is: muE = muA =/ muB = muD = muC



## Plotting the results ##
#windows()
par(las = 1, mai = c(0.9,0.9,0.5,0.2))
plot(Tukey1)



#*** The lines that touch the 0 line are the 
#    values that are not significantly different 
#    from zero --> Note the confidence intervals 
#    span zero

```


```{r ANOVA post hoc tukey}
#look at line 2014 of part2_statistical tests....
```



# In terms of size
```{r subset data by treatment, echo = FALSE}
data <- measurement_data
fa <- data %>% 
  filter(temperature == "ambient", diet == "formulated")

fw <- data %>% 
  filter(temperature == "warm", diet == "formulated") 

ma <- data %>% 
  filter(temperature == "ambient", diet == "mixed")

mw <- data %>% 
  filter(temperature == "warm", diet == "mixed")

ua <- data %>% 
  filter(temperature == "ambient", diet == "ulva")

uw <- data %>% 
  filter(temperature == "warm", diet == "ulva")

ka <- data %>% 
  filter(temperature == "ambient", diet == "kelp")

kw <- data %>% 
  filter(temperature == "warm", diet == "kelp")


```

plot actual size
```{r summarise actual data}
summarise_size <- function(data){
initial_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 0) %>% 
  summarise(size = round(mean(diam), digits = 2),sd = round(sd(diam), digits = 2),se = round((sd(diam)/sqrt(length(diam))), digits = 2), var = round(var(diam), digits = 4),n = length(diam),week = 0)

month1_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 1) %>% 
  summarise(size = round(mean(diam), digits = 2),sd = round(sd(diam), digits = 2),se = round((sd(diam)/sqrt(length(diam))), digits = 2), var = round(var(diam), digits = 4),n = length(diam),week = 4)

month2_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 2) %>% 
  summarise(size = round(mean(diam), digits = 2),sd = round(sd(diam), digits = 2),se = round((sd(diam)/sqrt(length(diam))), digits = 2), var = round(var(diam), digits = 4),n = length(diam),week = 8)

month3_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 3) %>% 
  summarise(size = round(mean(diam), digits = 2),sd = round(sd(diam), digits = 2),se = round((sd(diam)/sqrt(length(diam))), digits = 2), var = round(var(diam), digits = 4),n = length(diam),week = 13)

month4_dat <- data %>% 
  group_by(treatment) %>% 
  filter(time == 4) %>% 
  summarise(size = round(mean(diam), digits = 2),sd = round(sd(diam), digits = 2),se = round((sd(diam)/sqrt(length(diam))), digits = 2),var = round(var(diam), digits = 4),n = length(diam),week = 18)

all_size <- bind_rows(initial_dat, month1_dat, month2_dat, month3_dat, month4_dat)

}

all_size <- summarise_size(measurement_data)





```


```{r plot actual data}

attach(all_size)
ggplot(all_size, aes(x = week, y = size, color = as.factor(treatment))) +
  geom_line() +
  geom_point() +  geom_errorbar(aes(ymin = size - se, ymax = size + se), width = 0.2) +
  labs(title = "Cape sea urchin diameter (cm) over time",
       x = "Week",
       y = "Test diameter (cm)",
       color = "Treatment") +
  theme_classic() + theme(plot.title = element_text(family = "TT Times New Roman", hjust = 0.5))


# plot(week, weight, col = as.factor(treatment), xlab = "Week", ylab = "Weight (g)", ylim = range(c(weight-sd, weight+sd)))
# arrows(week,(weight-sd),week,(weight+sd),length = 0.5,angle = 90, code = 3, col = as.factor(treatment))


```



##Descriptive statistics:


function for size:
```{r message=FALSE, warning=FALSE, include=FALSE}


size_descriptive_table_notkelp <- function(data){
attach(data)
#########################################
# Creating a rounded descriptive table
#########################################
#** Creating the stats this you need to change
# Categorical variable
X = time
# Numerical variable
Y = diam
dat = data
########################################

#*****************************************
#****This does not change
Mean = aggregate(Y~X,data=dat,FUN=mean)
Stdev = aggregate(Y~X,data=dat,FUN=sd)
Var = aggregate(Y~X,data=dat,FUN=var)
n = aggregate(Y~X,data=dat,FUN=length)

# Create a table with the aggregated data
Dstats = data.frame(Mean, Stdev, Var, n)
Dstats
#******************************************

###########################################
# Part you need to change!
# Number of decimal places to round to 
###########################################
# decimals for mean and standard deviation are the same 
Deci1 = 2   
# Variance number of decimals twice that of the mean
Deci2 = 4
# Naming the Categorical variable
CatN = "Month"
# R assigns it's categories alphabetically
summary(data)
unclass(data$time)
data$time = as.factor(data$time)
unclass(data$time)

#attr(,"levels")
#[1] "0" "1" "4" "8"
# Copy the order of the variables EXACTLY
Catagorical = c("0","1", "2", "3", "4")
#############################################

#********************************************
# ***This does not change
# Creating rounded variables
# Round Mean & St.dev (g) to the same decimal places 
DstatsR1 = round(Dstats[,c(2,4)], Deci1)
# Round the variance  (g^2) to the correct number of decimal places
DstatsR2 = round(Dstats[,6], Deci2)
# Sample size
DstatsR3 = round(Dstats[,8],0)

# Creating a table with the categories 
#    and the descriptive stats
Descriptive4 = data.frame(Catagorical, 
                          DstatsR1, DstatsR2, DstatsR3) 
#**********************************************

################################################
# *** Setting up table column headers
# This needs to change every time 
# labels:

MeanL = "Mean (cm)"
SdL = "St. dev (cm)"
VarL = "Var (cm^2)"
nL = "n"
################################################

#**************************************************
# This part does not need to change

names(Descriptive4) = c(CatN, MeanL, SdL, VarL, nL)
# Now order the table by ascending Mean for 
# interpretation
# Order() -- Tells R you want to sort the data
# Descriptive$Mean -- Tells what variable in the table you 
# want to sort it by
# decreasing = False -- Sort in ascending order
Descriptive = Descriptive4[order(Descriptive4$Mean,
                                 decreasing=FALSE),]
Descriptive
}


size_descriptive_table_kelp <- function(data){
attach(data)
#########################################
# Creating a rounded descriptive table
#########################################
#** Creating the stats this you need to change
# Categorical variable
X = time
# Numerical variable
Y = diam
dat = data
########################################

#*****************************************
#****This does not change
Mean = aggregate(Y~X,data=dat,FUN=mean)
Stdev = aggregate(Y~X,data=dat,FUN=sd)
Var = aggregate(Y~X,data=dat,FUN=var)
n = aggregate(Y~X,data=dat,FUN=length)

# Create a table with the aggregated data
Dstats = data.frame(Mean, Stdev, Var, n)
Dstats
#******************************************

###########################################
# Part you need to change!
# Number of decimal places to round to 
###########################################
# decimals for mean and standard deviation are the same 
Deci1 = 2   
# Variance number of decimals twice that of the mean
Deci2 = 4
# Naming the Categorical variable
CatN = "Month"
# R assigns it's categories alphabetically
summary(data)
unclass(data$time)
data$time = as.factor(data$time)
unclass(data$time)

#attr(,"levels")
#[1] "0" "1" "4" "8"
# Copy the order of the variables EXACTLY
Catagorical = c("0","1", "2")
#############################################

#********************************************
# ***This does not change
# Creating rounded variables
# Round Mean & St.dev (g) to the same decimal places 
DstatsR1 = round(Dstats[,c(2,4)], Deci1)
# Round the variance  (g^2) to the correct number of decimal places
DstatsR2 = round(Dstats[,6], Deci2)
# Sample size
DstatsR3 = round(Dstats[,8],0)

# Creating a table with the categories 
#    and the descriptive stats
Descriptive4 = data.frame(Catagorical, 
                          DstatsR1, DstatsR2, DstatsR3) 
#**********************************************

################################################
# *** Setting up table column headers
# This needs to change every time 
# labels:

MeanL = "Mean (cm)"
SdL = "St. dev (cm)"
VarL = "Var (cm^2)"
nL = "n"
################################################

#**************************************************
# This part does not need to change

names(Descriptive4) = c(CatN, MeanL, SdL, VarL, nL)
# Now order the table by ascending Mean for 
# interpretation
# Order() -- Tells R you want to sort the data
# Descriptive$Mean -- Tells what variable in the table you 
# want to sort it by
# decreasing = False -- Sort in ascending order
Descriptive = Descriptive4[order(Descriptive4$Mean,
                                 decreasing=FALSE),]
Descriptive
}


# fa_weight<- Mean
# names(fa_weight) <- c("Month", "Mean weight (g)")
# 
# fa_weight_mean <- Mean
# names(fa_weight_mean) <- c("Month", "Mean weight (g)")
# fa_weight_sd <- Stdev
# names(fa_weight_sd) <- c("Month", "sd(g)")

```

using function for size:
```{r echo=FALSE, message=FALSE, warning=FALSE}
fa_descriptive_size <- size_descriptive_table_notkelp(fa)
fw_descriptive_size <- size_descriptive_table_notkelp(fw)
ma_descriptive_size <- size_descriptive_table_notkelp(ma)
mw_descriptive_size <- size_descriptive_table_notkelp(mw)
ua_descriptive_size <- size_descriptive_table_notkelp(ua)
uw_descriptive_size <- size_descriptive_table_notkelp(uw)

kw_descriptive_size <- size_descriptive_table_kelp(kw)
ka_descriptive_size <- size_descriptive_table_kelp(ka)

write.table(ka_descriptive_size,"clipboard", sep = "\t")
```


##Growth calculation

function for SGR size calculation:
```{r data_transform_weight_growth}
data<- measurement_data

data_transform_size_growth_SGR <- function(data){
initial_dat <- data %>% 
  group_by(tank,diet, temperature, treatment) %>% 
  filter(time == 0) %>% 
  summarise(T0_size = round(mean(diam), digits = 2),T0_size_sd = round(sd(diam), digits = 2),T0_size_var = round(var(diam), digits = 4),T0_size_n = length(diam))


month1_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 1) %>% 
  summarise(T1_size = round(mean(diam), digits = 2),T1_size_sd = round(sd(diam), digits = 2),T1_size_var = round(var(diam), digits = 4),T1_size_n = length(diam))

month2_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 2) %>% 
  summarise(T2_size = round(mean(diam), digits = 2),T2_size_sd = round(sd(diam), digits = 2),T2_size_var = round(var(diam), digits = 4),T2_size_n = length(diam))

month3_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 3) %>% 
  summarise(T3_size = round(mean(diam), digits = 2),T3_size_sd = round(sd(diam), digits = 2),T3_size_var = round(var(diam), digits = 4),T3_size_n = length(diam))

#set kelp tanks size to zero
# Find tanks that are only in month4_dat
kelp_tanks <- setdiff(month2_dat$tank, month3_dat$tank)

# Create a data frame with these tanks and set s_growth to 0
additional_data_month3 <- data.frame(tank = kelp_tanks,diet = "kelp", T3_size = 0)

month3_dat <- bind_rows(month3_dat, additional_data_month3)

month4_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 4) %>% 
  summarise(T4_size = round(mean(diam), digits = 2),T4_size_sd = round(sd(diam), digits = 2),T4_size_var = round(var(diam), digits = 4),T4_size_n = length(diam))

#set kelp tanks size to zero

# Create a data frame with these tanks and set s_growth to 0
additional_data_month4 <- data.frame(tank = kelp_tanks,diet = "kelp", T4_size = 0)
month4_dat <- bind_rows(month4_dat, additional_data_month4)

  
growth_dat1 <- left_join(initial_dat, month1_dat, by = "tank") %>% 
  group_by(tank) %>% 
  mutate(s_growth1 = 100*(log(T1_size/T0_size))/29) %>% distinct()

growth_dat2 <- left_join(month1_dat, month2_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(s_growth2 = 100*(log(T2_size/T1_size))/29) %>% distinct()


growth_dat3 <- left_join(month2_dat,month3_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(s_growth3 = coalesce((100*(log(T3_size/T2_size))/32),0)) %>%  distinct()




#growth_dat3 <- replace(growth_dat3, is.na(growth_dat3),0)


growth_dat4 <- left_join(month3_dat,month4_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(s_growth4 = coalesce((100*(log(T4_size/T3_size))/36), 0)) %>% distinct() %>%mutate(tank = as.numeric(tank)) %>%
  arrange(tank)



growth_dat <- data.frame(growth_dat1[,1:4],growth_dat1$s_growth1,growth_dat2$s_growth2, growth_dat3$s_growth3, growth_dat4$s_growth4)

names(growth_dat) <- c("tank", "diet", "temperature", "treatment", "s_growth1", "s_growth2", "s_growth3", "s_growth4")


# Setting growth rate 3 to zero for kelp tanks
tanks_to_set_to_zero <- kelp_tanks

# Use mutate() and ifelse() to change the values
growth_dat <- growth_dat %>%
  mutate(s_growth3 = ifelse(tank %in% tanks_to_set_to_zero, 0, s_growth3), s_growth4 = ifelse(tank %in% tanks_to_set_to_zero, 0, s_growth4))

growth_dat <- round(growth_dat[,5:8],digits = 2)

growth_dat <- data.frame(month1_dat[,1:4],growth_dat)
names(growth_dat) <- c("tank", "diet", "temperature", "treatment", "s_growth1", "s_growth2", "s_growth3", "s_growth4")
growth_dat
}

size_SGR_dat <- data_transform_size_growth_SGR(data)


```

check normality and homoscedasticity
```{r}
#*********************************
#** Shapiro-Wilk normality test **
#*********************************
# If p > 0.05, we can be 95% certain that the 
# data are normally distributed. 
# (In other words, the null hypothesis is 
#   probably true.) 
# If p < 0.05, we can be 95% certain that the 
# data are not normally distributed. 
# (In other words, the null hypothesis is 
#   probably false.) 

# H0: The data are normally distributed
# H1: The data are not normally distributed
# alpha = 0.05

shapiro.test(size_SGR_dat$s_growth1) #not normal #W = 0.8022, p-value = 4.483e-05
shapiro.test(size_SGR_dat$s_growth2) #W = 0.98382, p-value = 0.8997
shapiro.test(size_SGR_dat$s_growth3) #not normal #W = 0.88329, p-value = 0.002389
shapiro.test(size_SGR_dat$s_growth4) #not normal #W = 0.88237, p-value = 0.002269

#*********************************
#** Levene homoscedasticity test **
#*********************************
#If values are significant, the treatment group data does not have equal variances

require("car")

leveneTest(size_SGR_dat$s_growth1~size_SGR_dat$treatment) #equal variance
#       Df F value Pr(>F)
# group 7  0.8084 0.5889
#       24     
leveneTest(size_SGR_dat$s_growth2~size_SGR_dat$treatment)  #equal variance
#       Df F value  Pr(>F)  
# group  7  1.5797 0.1894
#       24    
leveneTest(size_SGR_dat$s_growth3~size_SGR_dat$treatment)  #equal variance
#       Df F value   Pr(>F)   
# group  7   1.733 0.1486
#       24
leveneTest(size_SGR_dat$s_growth4~size_SGR_dat$treatment) #equal variance
#       Df F value Pr(>F)
# group  7  1.3173 0.2849
#       24           
```


function for size growth calculation:
```{r data_transform_size_growth}
data<- measurement_data

data_transform_size_growth <- function(data){
initial_dat <- data %>% 
  group_by(tank,diet, temperature, treatment) %>% 
  filter(time == 0) %>% 
  summarise(T0_size = round(mean(diam), digits = 2),T0_size_sd = round(sd(diam), digits = 2),T0_size_var = round(var(diam), digits = 4),T0_size_n = length(diam))


month1_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 1) %>% 
  summarise(T1_size = round(mean(diam), digits = 2),T1_size_sd = round(sd(diam), digits = 2),T1_size_var = round(var(diam), digits = 4),T1_size_n = length(diam))

month2_dat <- data %>% 
  group_by(tank, diet, temperature, treatment) %>% 
  filter(time == 2) %>% 
  summarise(T2_size = round(mean(diam), digits = 2),T2_size_sd = round(sd(diam), digits = 2),T2_size_var = round(var(diam), digits = 4),T2_size_n = length(diam))

month3_dat <- data %>% 
  group_by(tank, diet, temperature,treatment) %>% 
  filter(time == 3) %>% 
  summarise(T3_size = round(mean(diam), digits = 2),T3_size_sd = round(sd(diam), digits = 2),T3_size_var = round(var(diam), digits = 4),T3_size_n = length(diam))

#set kelp tanks size to zero
# Find tanks that are only in month4_dat
kelp_tanks <- setdiff(month2_dat$tank, month3_dat$tank)

# Create a data frame with these tanks and set s_growth to 0
additional_data_month3 <- data.frame(tank = kelp_tanks,diet = "kelp", T3_size = 0)

month3_dat <- bind_rows(month3_dat, additional_data_month3)

month4_dat <- data %>% 
  group_by(tank, diet, temperature,treatment) %>% 
  filter(time == 4) %>% 
  summarise(T4_size = round(mean(diam), digits = 2),T4_size_sd = round(sd(diam), digits = 2),T4_size_var = round(var(diam), digits = 4),T4_size_n = length(diam))

#set kelp tanks size to zero

# Create a data frame with these tanks and set s_growth to 0
additional_data_month4 <- data.frame(tank = kelp_tanks,diet = "kelp", T4_size = 0)
month4_dat <- bind_rows(month4_dat, additional_data_month4)

  
growth_dat1 <- left_join(initial_dat, month1_dat, by = "tank") %>% 
  group_by(tank) %>% 
  mutate(s_growth1 = T1_size-T0_size) %>% distinct()

growth_dat2 <- left_join(month1_dat, month2_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(s_growth2 = T2_size-T1_size) %>% distinct()


growth_dat3 <- left_join(month2_dat,month3_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(s_growth3 = coalesce(T3_size-T2_size,0)) %>%  distinct()




#growth_dat3 <- replace(growth_dat3, is.na(growth_dat3),0)


growth_dat4 <- left_join(month3_dat,month4_dat,by = "tank") %>%
  group_by(tank) %>%
  mutate(s_growth4 = coalesce(T4_size - T3_size, 0)) %>% distinct() %>%mutate(tank = as.numeric(tank)) %>%
  arrange(tank)



growth_dat <- data.frame(growth_dat1[,1:3],growth_dat1$s_growth1,growth_dat2$s_growth2, growth_dat3$s_growth3, growth_dat4$s_growth4)

names(growth_dat) <- c("tank", "diet", "temperature", "s_growth1", "s_growth2", "s_growth3", "s_growth4")


# Setting growth rate 3 to zero for kelp tanks
tanks_to_set_to_zero <- kelp_tanks

# Use mutate() and ifelse() to change the values
growth_dat <- growth_dat %>%
  mutate(s_growth3 = ifelse(tank %in% tanks_to_set_to_zero, 0, s_growth3), s_growth4 = ifelse(tank %in% tanks_to_set_to_zero, 0, s_growth4))

growth_dat <- round(growth_dat[,4:7],digits = 2)

growth_dat <- data.frame(month1_dat[,1:4],growth_dat)
names(growth_dat) <- c("tank", "diet", "temperature","treatment", "s_growth1", "s_growth2", "s_growth3", "s_growth4")
growth_dat
}

size_growth_dat <- data_transform_size_growth(data)


```


#look for significant differences:

create descriptive tables
```{r desciptive tables for ANOVA, echo = FALSE }
#We want to see if weight gain (g) differs between treatments

size_growth_dat$treatment <- weight_growth_dat$treatment


attach(size_growth_dat)
names(size_growth_dat)
summary(size_growth_dat)

unclass(treatment)
size_growth_dat$treatment = as.factor(size_growth_dat$treatment)
unclass(size_growth_dat$treatment)
summary(size_growth_dat)

dat <- size_growth_dat
#growth_period is e.g. w_growth 1
treatment_size_growth_table <- function(growth_period){


#########################################
# Creating a rounded descriptive table
#########################################
#** Creating the stats this you need to change
# Categorical variable
X = treatment
# Numerical variable
Y = growth_period
data = size_growth_dat
########################################

#*****************************************
#****This does not change
Mean = aggregate(Y~X,data=dat,FUN=mean)
Stdev = aggregate(Y~X,data=dat,FUN=sd)
Var = aggregate(Y~X,data=dat,FUN=var)
n = aggregate(Y~X,data=dat,FUN=length)

# Create a table with the aggregated data
Dstats = data.frame(Mean, Stdev, Var, n)
Dstats
#******************************************

###########################################
# Part you need to change!
# Number of decimal places to round to 
###########################################
# decimals for mean and standard deviation are the same 
Deci1 = 3   
# Variance number of decimals twice that of the mean
Deci2 = 6
# Naming the Categorical variable
CatN = "Treatments"
# R assigns it's categories alphabetically
summary(dat)
unclass(dat$treatment)
#attr(,"levels")
#[1] "A" "B" "C" "D" "E"
# Copy the order of the variables EXACTLY
Catagorical = c("FA","FW","KA","KW","MA", "MW", "UA", "UW")
#############################################

#********************************************
# ***This does not change
# Creating rounded variables
# Round Mean & St.dev (g) to the same decimal places 
DstatsR1 = round(Dstats[,c(2,4)], Deci1)
# Round the variance  (g^2) to the correct number of decimal places
DstatsR2 = round(Dstats[,6], Deci2)
# Sample size
DstatsR3 = round(Dstats[,8],0)

# Creating a table with the categories 
#    and the descriptive stats
Descriptive4 = data.frame(Catagorical, 
                          DstatsR1, DstatsR2, DstatsR3) 
#**********************************************

################################################
# *** Setting up table column headers
# This needs to change every time 
# labels:
MeanL = "Mean (cm)"
SdL = "St. dev (cm)"
VarL = "Var (cm^2)"
nL = "n"
################################################

#**************************************************
# This part does not need to change
names(Descriptive4) = c(CatN, MeanL, SdL, VarL, nL)
# Now order the table by ascending Mean for 
# interpretation
# Order() --> Tells R you want to sort the data
# Descriptive$Mean --> Tells what variable in the table you 
# want to sort it by
# decreasing = False --> Sort in ascending order
Descriptive = Descriptive4[order(Descriptive4$Mean,
                                 decreasing=FALSE),]
Descriptive


}

dat_s_growth1<- treatment_size_growth_table(s_growth1)
dat_s_growth2<- treatment_size_growth_table(s_growth2)
dat_s_growth3<- treatment_size_growth_table(s_growth3)
dat_s_growth4<- treatment_size_growth_table(s_growth4)

#write.table(dat_w_growth3,"clipboard", sep = "\t")

#******************************************************

# Table 1.  Descriptive statistics for body weights (g) for each
#           of the five different Islands where the mean, standard
#           deviation (St.dev), Variance (Var) and sample size (n).
        # Island  Mean(g)  St. dev(g)    Var(g^2)    n
        #5      E 38.47    6.74           45.4033    40
        #1      A 42.38    7.27           52.8032    40
        #2      B 53.98    7.17           51.4261    40
        #4      D 54.30    7.27           52.8269    40
        #3      C 54.74    7.24           52.4738    40



#** Question: Is there a difference in Weight 
#    between the treatments


```



boxplots 

```{r}
# data exploration using a box plot

#growth_period is e.g. w_growth 1

treatment_size_growth_boxplot <- function(growth_period){
#** Visualizing what the data look like
ylab="Size difference (cm)"
xlab="Treatments"
par(las = 1)
boxplot(growth_period~treatment, data=dat, 
        ylab=ylab, 
        xlab=xlab, col= c("red", "red", "yellow", "yellow", "blue", "blue", "green", "green"))
legend("topleft", c("IQR","Median","Outlier"), 
       pch=c(22,15,1), bty="n")
}


treatment_size_growth_boxplot(s_growth1)
treatment_size_growth_boxplot(s_growth2)
treatment_size_growth_boxplot(s_growth3)
treatment_size_growth_boxplot(s_growth4)

#** You have more than two levels and continuous data
#** So do ANOVA or Kruskal Wallis 
#   Either test assumptions beforehand or fit ANOVA
#   and test assumptions after.

#><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>><>
```



#ANOVA or Kruskal Wallis:
Run ANOVA, then check assumptions, if not met, do Kruskal Wallis
```{r check ANOVA assumptions}
#*** run an ANOVA using the aov function
#*** First fit the model to check the assumptions
#**Then see if there is a difference between or among groups


# H0: muE = muA = muB = muD = muC 
      #(The mean weights are the same on each island)
# H1: the mean weights are not the same on each island
# alpha = 0.05
#Anova = aov(numerical~Categorical, data = dat)

dat<- size_growth_dat
anova_and_modelval <- function(growth_period){
anova1 <- aov(growth_period~diet*temperature,data=dat)
#model validation graphs
res <- residuals(anova1)
## Now pull out your fitted values
yfit <- fitted.values(anova1)

xlab1="Predicted values (g)"
ylab1="Residuals (g)"
par(mfrow=c(1,3),mex=0.8, las = 1, mai = c(0.5,0.5,0.5,0.1))
## Looking at the spread of the residuals to check Variances. 
##   Remember to add units to both labels 
plot(yfit,res,xlab=xlab1,ylab=ylab1)
abline(0,0,lty=3)
legend ("topleft", expression(bold("a")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
### Looking at Normality.  Remember to add units to the 
###   residual label
qqnorm(res,main="Model Validation")
qqline(res)
legend ("topleft", expression(bold("b")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
hist(res,main= "",xlab=ylab1)
legend ("topleft", expression(bold("c")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
}

#look at model validation before continuing
# Look at the model validation Figures to check the 
# assumptions
#Figure a checks the assumption of equal variance, 
#   if the spread of the residuals is similar 
#   above and below the line and there is no 
#   pattern in the residuals the variances are 
#   similar.
#Figure b-c checks the assumption of a normal 
#  distribution, if the points for the residuals 
#  in Figure b follow close to the line the data 
#  are normal.  If the histogram in Figure c has the 
#  bell shaped curve the data are normally distributed

#So if the assumptions are met, use the ANOVA results; 
  #if the data are not normal do a Kruskal Wallis
anova_and_modelval(s_growth1) #unequal variance? skewed normal dist
anova_and_modelval(s_growth2) #good
#anova_and_modelval(s_growth3) #non normal
#anova_and_modelval(s_growth4) #

anova1 <- aov(s_growth2~diet*temperature,data=dat)
summary(anova1)

```

Removing kelp for growth period 2 to 4
This function isn't really working, I did it manually for the growth periods 2-4
```{r ANOVA without kelp}

size_growth_dat_no_kelp <- size_growth_dat %>% filter(diet!= "kelp")
dat <- size_growth_dat_no_kelp

no_kelp_anova_and_modelval <- function(growth_period){
anova1 <- aov(s_growth4~diet*temperature,data=size_growth_dat_no_kelp)
#model validation graphs
res <- residuals(anova1)
## Now pull out your fitted values
yfit <- fitted.values(anova1)

xlab1="Predicted values (g)"
ylab1="Residuals (g)"
par(mfrow=c(1,3),mex=0.8, las = 1, mai = c(0.5,0.5,0.5,0.1))
## Looking at the spread of the residuals to check Variances. 
##   Remember to add units to both labels 
plot(yfit,res,xlab=xlab1,ylab=ylab1)
abline(0,0,lty=3)
legend ("topleft", expression(bold("a")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
### Looking at Normality.  Remember to add units to the 
###   residual label
qqnorm(res,main="Model Validation")
qqline(res)
legend ("topleft", expression(bold("b")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
hist(res,main= "",xlab=ylab1)
legend ("topleft", expression(bold("c")), 
        x.intersp = 0, bty = "n", 
        cex = 1.3)
}

summary(anova1)

no_kelp_anova_and_modelval(w_growth2)
anova_and_modelval(w_growth3) 
anova_and_modelval(w_growth4)
```


```{r check ANOVA results}
anova_results <- function(growth_period){
anova1 <- aov(growth_period~treatment,data=dat)
summary(anova1)
}

#growth period 1
aov_wgrowth1<- anova_results(w_growth1)

```

```{r ANOVA post hoc tukey}
#look at line 2014 of part2_statistical tests....
```



#Plot

Plotting weight and size growth together

```{r}

sizes <- measurement_data %>% group_by(treatment,time) %>% summarise(mean_diam = mean(diam))
weights<- parechinus_data %>% group_by(treatment,time) %>% summarise(mean_weight = mean(`weight (g)`))

ws_urchins <- left_join(sizes,weights)
ws_urchins$weight_size <- ws_urchins$mean_weight/ws_urchins$mean_diam

plot(ws_urchins$time,ws_urchins$weight_size,col = as.factor(ws_urchins$treatment))
legend()
```



```{r}
growth_table <- function(treatment){
treatment_growth <- treatment
treatment_growth <- treatment %>% 
  group_by(tank)%>% 
  mutate(w_growth = `weight (g)` -lag(`Mean weight (g)`))
treatment_growth[is.na(treatment_growth)] <- 0

#treatment_growth$w_growth <- c(0,(treatment[2,2]-treatment[1,2]),(treatment[3,2]-treatment[2,2]), (treatment[4,2]-treatment[3,2]), (treatment[5,2]-treatment[4,2]))

treatment_growth
}

ua_weight_growth <- growth_table(ua_weight)
ua_weight_growth <- growth_table(ua_weight)
```




general plots
```{r}
plot(t0$treatment, fa$`weight (g)`, xlab = "Time (months)", ylab = "Urchin weight (g)")
```



plots
```{r}

plot(data$ , uw, xlab = "Shell length (mm)", 
     ylab = "Shell width (mm)", col = "blue", main = "All data")
points(c_gdat$Length, c_gdat$Width, col = "red")
legend("bottomright", c("Treatment", "Control"), col = c("blue", "red"), pch = c(21,21), bty = "n")
```



A function is used to transform the data and calculate somatic growth rate in terms of weight gain & size increase.

```{r function, echo=FALSE}
data_transform_weight <- function(data){
initial_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 0) %>% 
  summarise(diet = diet, temperature = temperature, T0_weight = mean(`weight (g)`)) 


month1_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 1) %>% 
  summarise(T1_weight = mean(`weight (g)`))

month2_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 2) %>% 
  summarise(T2_weight = mean(`weight (g)`))

month3_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 3) %>% 
  summarise(T3_weight = mean(`weight (g)`))

month4_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 4) %>% 
  summarise(T4_weight = mean(`weight (g)`))

  
growth_dat1 <- initial_dat %>% left_join(month1_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T1_weight-T0_weight) %>% distinct()

growth_dat2 <- month1_dat %>% left_join(month2_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T2_weight-T1_weight) %>% distinct()

growth_dat3 <- month2_dat %>% left_join(month3_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T3_weight-T2_weight) %>% distinct()

growth_dat4 <- month3_dat %>% left_join(month4_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T4_weight-T3_weight) %>% distinct()

growth_dat1
growth_dat2
growth_dat3
growth_dat4
}
weight_growth <- data_transform_weight(data)

write.csv(weight_growth, "weight_growth_data.csv", row.names = FALSE)

```


```{r function, echo=FALSE}

#want to use this when my size data has been captured

data_transform_somatic <- function(data){
initial_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 0) %>% 
  summarise(diet = diet, temperature = temperature, T0_weight = mean(`weight (g)`), T0_size = mean(diam_ave)) 


month1_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 1) %>% 
  summarise(T1_weight = mean(`weight (g)`), T1_size = mean(diam_ave))

month2_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 2) %>% 
  summarise(T2_weight = mean(`weight (g)`), T2_size = mean(diam_ave))

month3_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 3) %>% 
  summarise(T3_weight = mean(`weight (g)`), T3_size = mean(diam_ave))

month4_dat <- data %>% 
  group_by(tank) %>% 
  filter(time == 4) %>% 
  summarise(T4_weight = mean(`weight (g)`), T4_size = mean(diam_ave))

  
growth_dat1 <- initial_dat %>% left_join(month1_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T1_weight-T0_weight, s_growth = T1_size - T0_size) %>% distinct()

growth_dat2 <- month1_dat %>% left_join(month2_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T2_weight-T1_weight, s_growth = T2_size - T1_size) %>% distinct()

growth_dat3 <- month2_dat %>% left_join(month3_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T3_weight-T2_weight, s_growth = T3_size - T2_size) %>% distinct()

growth_dat4 <- month3_dat %>% left_join(month4_dat,by = "tank") %>% 
  group_by(tank, diet, temperature) %>% 
  mutate(w_growth = T4_weight-T3_weight, s_growth = T4_size - T3_size) %>% distinct()

growth_dat1
growth_dat2
growth_dat3
growth_dat4
}
somatic_growth <- data_transform_somatic(data)

write.csv(somatic_growth, "somatic_growth_data.csv", row.names = FALSE)

```


```{r, echo=FALSE}

weight_gain_plot <- ggplot(somatic_growth, aes(x = diet, y = w_growth, fill = as.factor(temperature))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Growth Rate per Diet per Temperature",
       x = "Diet", y = "Growth Rate (g/month)",
       fill = "Temperature") +
  theme_classic()+scale_fill_grey()

print(weight_gain_plot)

```

-   Size increase

```{r, echo=FALSE}

size_growth_plot <- ggplot(somatic_growth, aes(x = diet, y = s_growth, fill = as.factor(temperature))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Growth Rate per Diet per Temperature",
       x = "Diet", y = "Growth Rate (cm/month)",
       fill = "Temperature") + geom_hline(yintercept=0, 
                color = "black", size=0.5) +
  theme_classic()+scale_fill_grey()

print(size_growth_plot)

```

```{r subset data by time, echo = FALSE}
t0<- data %>% 
  filter(time == "0")

t1<- data %>% 
  filter(time == "1")

t2<- data %>% 
  filter(time == "2")

t3<- data %>% 
  filter(time == "3")

t4<- data %>% 
  filter(time == "4")
```

```{r subset treatment by time}
#formulated ambient
fa_1 <- fa %>% 
  filter(time == "1")

fa_2 <- fa %>% 
  filter(time == "2")

fa_3 <- fa %>% 
  filter(time == "3")

fa_4 <- fa %>% 
  filter(time == "4")

#formulated warm
fw_1 <- fw %>% 
  filter(time == "1")

fw_2 <- fw %>% 
  filter(time == "2")

fw_3 <- fw %>% 
  filter(time == "3")

fw_4 <- fw %>% 
  filter(time == "4")

#mixed ambient
ma_1 <- ma %>% 
  filter(time == "1")

ma_2 <- ma %>% 
  filter(time == "2")

ma_3 <- ma %>% 
  filter(time == "3")

ma_4 <- ma %>% 
  filter(time == "4")

#mixed warm
mw_1 <- mw %>% 
  filter(time == "1")

mw_2 <- mw %>% 
  filter(time == "2")

mw_3 <- mw %>% 
  filter(time == "3")

mw_4 <- mw %>% 
  filter(time == "4")

#ulva ambient
ua_1 <- ua %>% 
  filter(time == "1")

ua_2 <- ua %>% 
  filter(time == "2")

ua_3 <- ua %>% 
  filter(time == "3")

ua_4 <- ua %>% 
  filter(time == "4")

#ulva warm
uw_1 <- uw %>% 
  filter(time == "1")

uw_2 <- uw %>% 
  filter(time == "2")

uw_3 <- uw %>% 
  filter(time == "3")

uw_4 <- uw %>%
```


```{r subset treatment by time}
filter(time == "4")

```


###2.  **Feed Conversion Ratio**

Formula used:$$
feed consumed / weight gain
$$



